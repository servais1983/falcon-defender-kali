import pytest
from src.exploitation import ExploitationModule, Vulnerability

def test_vulnerability_loading():
    """Test le chargement des vulnérabilités"""
    module = ExploitationModule()
    assert len(module.vulnerabilities) > 0
    assert isinstance(module.vulnerabilities, dict)

def test_analyze_target():
    """Test l'analyse d'une cible"""
    module = ExploitationModule()
    target_info = {
        'name': 'Test Drone',
        'version': '1.0.0',
        'type': 'quadcopter'
    }
    vulns = module.analyze_target(target_info)
    assert isinstance(vulns, list)
    assert all(isinstance(v, Vulnerability) for v in vulns)

def test_generate_report():
    """Test la génération de rapport"""
    module = ExploitationModule()
    target_info = {
        'name': 'Test Drone',
        'version': '1.0.0',
        'type': 'quadcopter'
    }
    vulns = module.analyze_target(target_info)
    report = module.generate_report(target_info, vulns)
    
    assert isinstance(report, dict)
    assert 'timestamp' in report
    assert 'target' in report
    assert 'vulnerabilities' in report
    assert 'summary' in report
    assert 'total_vulns' in report['summary']

def test_vulnerability_severity():
    """Test la classification des sévérités"""
    module = ExploitationModule()
    target_info = {
        'name': 'Test Drone',
        'version': '1.0.0',
        'type': 'quadcopter'
    }
    vulns = module.analyze_target(target_info)
    report = module.generate_report(target_info, vulns)
    
    summary = report['summary']
    assert summary['total_vulns'] == len(vulns)
    assert summary['critical'] + summary['high'] + summary['medium'] + summary['low'] == len(vulns)

def test_invalid_target():
    """Test avec des informations de cible invalides"""
    module = ExploitationModule()
    target_info = {
        'name': 'Invalid Drone',
        'version': '999.999.999',
        'type': 'unknown'
    }
    vulns = module.analyze_target(target_info)
    assert isinstance(vulns, list)
    assert len(vulns) == 0  # Ne devrait trouver aucune vulnérabilité pour une version invalide 